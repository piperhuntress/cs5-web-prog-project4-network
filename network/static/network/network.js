document.addEventListener('DOMContentLoaded', function() {

  function getCookie(name) {
      var cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          var cookies = document.cookie.split(';');
          for (var i = 0; i < cookies.length; i++) {
              var cookie = jQuery.trim(cookies[i]);
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }
  var csrftoken = getCookie('csrftoken');

  //get all the buttons with the class like
  var buttons = document.querySelectorAll('.like');
  var clicked_id =""; //variable for the clicked posts
  var clicked_id_link =""; //variable for the clicked posts

  //get all the links with the class editlink
  var editlinks = document.querySelectorAll('.editlink')

  //get all the submit buttons for editing for each of the post
  var editbuttons = document.querySelectorAll('.editbutton')


//hide the edit boxes initially
var edit = document.querySelectorAll('.editpost');
for (var i=0; i<edit.length; ++i) {
  edit[i].style.display = 'none'
}

//eventlistener for edit submit buttons
for (var i=0; i<editbuttons.length; ++i) {
    editbuttons[i].onclick = function() {
    clicked_id_btn = this.id
    id= clicked_id_btn.substr(0, clicked_id_btn.indexOf('-'));
    //send a request to edit view
      fetch('/edit/'+id, {
        credentials: 'include',
          method: 'POST',
          mode: 'same-origin',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
          },
          body: JSON.stringify({
              post_id:this.id,
              post_message:document.querySelector('#message'+id).value
          })
      })
      .then(response => response.json())
      .then(result => {
          // Print result
          console.log(result);
          document.querySelector('#editpost'+id).style.display = 'none';
          document.querySelector('#post_message'+id).innerHTML = result['message']
          document.querySelector('.post-details'+id).style.display = 'block';

      });
    return false;
  }
}


//eventlistener for edit links
for (var i=0; i<editlinks.length; ++i) {
  editlinks[i].onclick = function() {
    clicked_id_link = this.id
    id= clicked_id_link.substr(0, clicked_id_link.indexOf('-'));
    if(document.querySelector('#editpost'+id).style.display == 'block'){
      document.querySelector('#editpost'+id).style.display = 'none';
      document.querySelector('.post-details'+id).style.display = 'block';
    }
    else{
      document.querySelector('#editpost'+id).style.display = 'block';
      document.querySelector('.post-details'+id).style.display = 'none';
    }
    return false;
  }
}


//eventlistener for like and unlike
for (var i=0; i<buttons.length; ++i) {
  clicked_id = this.id

    buttons[i].onclick = function() {
      clicked_id = this.id
        fetch('/like/'+this.id, {
          credentials: 'include',
            method: 'POST',
            mode: 'same-origin',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json',
              'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                post_id:this.id
            })
        })
        .then(response => response.json())
        .then(result => {
            // Process the result in json format generated by the view if there is
            //if post has been liked
            user_likes = result["user_likes"];
            // for (var key of Object.keys(user_likes)) {
            //     console.log(key + " -> " + user_likes[key])
            // }
            console.log(user_likes)
            // for(var key in user_likes){
            //     console.log('key - ' + key + '  value - ' + user_likes[key]);
            // }
            if(result['liked'] == 'True'){
              this.innerHTML = "<img src='/static/network/images/liked.png'/>";
              document.querySelector('#total_likes'+this.id).innerHTML = "Likes ("+result['total_likes']+")";
              document.querySelector('#user_likes'+this.id).innerHTML = result["user_likes"];
            }
            else {
              this.innerHTML = '<img src="/static/network/images/notliked.png"/>';
              document.querySelector('#total_likes'+this.id).innerHTML = "Likes ("+result['total_likes']+")";
              document.querySelector('#user_likes'+this.id).innerHTML = result["user_likes"];
              }
        });
      return false;
    }
  }

}); //end DOMContentLoaded
